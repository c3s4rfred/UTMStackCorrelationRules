# Based on CVE-2022-22027 Vulnerability
# And https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-22047?ranMID=46131&ranEAID=a1LgFw09t88&ranSiteID=a1LgFw09t88-wPNH8LnUnMEYco7zZP6Ukg&epi=a1LgFw09t88-wPNH8LnUnMEYco7zZP6Ukg&irgwc=1&OCID=AID2200057_aff_7806_1243925&tduid=%28ir__wb9j2ac2vkkfb2pyyi2kh3g3232xvfz3eg6oft0y00%29%287806%29%281243925%29%28a1LgFw09t88-wPNH8LnUnMEYco7zZP6Ukg%29%28%29&irclickid=_wb9j2ac2vkkfb2pyyi2kh3g3232xvfz3eg6oft0y00
# And https://nvd.nist.gov/vuln/detail/CVE-2022-22047
# And https://socprime.com/blog/knotweed-activity-detection-cve-2022-22047-vulnerability-and-multiple-windows-adobe-zero-day-exploitation-by-the-european-private-sector-offensive-actor-psoa/
# Rule version v1.0.0

- name: "Attempted exploitation of the CVE-2022-22027 vulnerability"
  severity: "High"
  description: "Windows CSRSS Elevation of Privilege Vulnerability. An attacker who successfully exploited this vulnerability could gain SYSTEM privileges."
  solution: "We recommend updating the version of Windows to correct security problems"
  category: "Execution"
  tactic: "Command and Scripting Interpreter"
  dataTypes: ["generic"]
  reference:
    - "https://attack.mitre.org/tactics/TA0002/"
    - "https://attack.mitre.org/techniques/T1059/"
  frequency: 60
  cache: 
    - oneOf:
        - field: "logx.*.hash"
          operator: "regexp"
          value: "(78c255a98003a101fa5ba3f49c50c6922b52ede601edac5db036ab72efc57629|0588f61dc7e4b24554cffe4ea56d043d8f6139d2569bc180d4a77cf75b68792f|441a3810b9e89bae12eea285a63f92e98181e9fb9efd6c57ef6d265435484964|cbae79f66f724e0fe1705d6b5db3cc8a4e89f6bdf4c37004aa1d45eeab26e84b|fd6515a71530b8329e2c0104d0866c5c6f87546d4b44cc17bbb03e64663b11fc|5d169e083faa73f2920c8593fb95f599dad93d34a6aa2b0f794be978e44c8206|7f29b69eb1af1cc6c1998bad980640bfe779525fd5bb775bc36a0ce3789a8bfc|02a59fe2c94151a08d75a692b550e66a8738eb47f0001234c600b562bf8c227d|7f84bf6a016ca15e654fb5ebc36fd7407cb32c69a0335a32bfc36cb91e36184d|afab2e77dc14831f1719e746042063a8ec107de0e9730249d5681d07f598e5ec|894138dfeee756e366c65a197b4dbef8816406bc32697fac6621601debe17d53|4611340fdade4e36f074f75294194b64dcf2ec0db00f3d958956b4b0d6586431|c96ae21b4cf2e28eec222cfe6ca903c4767a068630a73eca58424f9a975c6b7d|fa30be45c5c5a8f679b42ae85410f6099f66fe2b38eb7aa460bcc022babb41ca|e64bea4032cf2694e85ede1745811e7585d3580821a00ae1b9123bb3d2d442d6)"
        - field: "logx.*.msg"
          operator: "regexp"
          value: "(78c255a98003a101fa5ba3f49c50c6922b52ede601edac5db036ab72efc57629|0588f61dc7e4b24554cffe4ea56d043d8f6139d2569bc180d4a77cf75b68792f|441a3810b9e89bae12eea285a63f92e98181e9fb9efd6c57ef6d265435484964|cbae79f66f724e0fe1705d6b5db3cc8a4e89f6bdf4c37004aa1d45eeab26e84b|fd6515a71530b8329e2c0104d0866c5c6f87546d4b44cc17bbb03e64663b11fc|5d169e083faa73f2920c8593fb95f599dad93d34a6aa2b0f794be978e44c8206|7f29b69eb1af1cc6c1998bad980640bfe779525fd5bb775bc36a0ce3789a8bfc|02a59fe2c94151a08d75a692b550e66a8738eb47f0001234c600b562bf8c227d|7f84bf6a016ca15e654fb5ebc36fd7407cb32c69a0335a32bfc36cb91e36184d|afab2e77dc14831f1719e746042063a8ec107de0e9730249d5681d07f598e5ec|894138dfeee756e366c65a197b4dbef8816406bc32697fac6621601debe17d53|4611340fdade4e36f074f75294194b64dcf2ec0db00f3d958956b4b0d6586431|c96ae21b4cf2e28eec222cfe6ca903c4767a068630a73eca58424f9a975c6b7d|fa30be45c5c5a8f679b42ae85410f6099f66fe2b38eb7aa460bcc022babb41ca|e64bea4032cf2694e85ede1745811e7585d3580821a00ae1b9123bb3d2d442d6)"
        - field: "logx.*.fileHash"
          operator: "regexp"
          value: "(78c255a98003a101fa5ba3f49c50c6922b52ede601edac5db036ab72efc57629|0588f61dc7e4b24554cffe4ea56d043d8f6139d2569bc180d4a77cf75b68792f|441a3810b9e89bae12eea285a63f92e98181e9fb9efd6c57ef6d265435484964|cbae79f66f724e0fe1705d6b5db3cc8a4e89f6bdf4c37004aa1d45eeab26e84b|fd6515a71530b8329e2c0104d0866c5c6f87546d4b44cc17bbb03e64663b11fc|5d169e083faa73f2920c8593fb95f599dad93d34a6aa2b0f794be978e44c8206|7f29b69eb1af1cc6c1998bad980640bfe779525fd5bb775bc36a0ce3789a8bfc|02a59fe2c94151a08d75a692b550e66a8738eb47f0001234c600b562bf8c227d|7f84bf6a016ca15e654fb5ebc36fd7407cb32c69a0335a32bfc36cb91e36184d|afab2e77dc14831f1719e746042063a8ec107de0e9730249d5681d07f598e5ec|894138dfeee756e366c65a197b4dbef8816406bc32697fac6621601debe17d53|4611340fdade4e36f074f75294194b64dcf2ec0db00f3d958956b4b0d6586431|c96ae21b4cf2e28eec222cfe6ca903c4767a068630a73eca58424f9a975c6b7d|fa30be45c5c5a8f679b42ae85410f6099f66fe2b38eb7aa460bcc022babb41ca|e64bea4032cf2694e85ede1745811e7585d3580821a00ae1b9123bb3d2d442d6)"
        - field: "logx.*.url"
          operator: "regexp"
          value: "(acrobatrelay.com|finconsult.cc|realmetaldns.com)"
        - field: "logx.*.requestUrl"
          operator: "regexp"
          value: "(acrobatrelay.com|finconsult.cc|realmetaldns.com)"
        - field: "logx.*.domain"
          operator: "regexp"
          value: "(acrobatrelay.com|finconsult.cc|realmetaldns.com)"
        - field: "logx.*.Domain"
          operator: "regexp"
          value: "(acrobatrelay.com|finconsult.cc|realmetaldns.com)"
        - field: "logx.*.msg"
          operator: "regexp"
          value: "(acrobatrelay.com|finconsult.cc|realmetaldns.com)"
        - field: "logx.*.object_uri"
          operator: "regexp"
          value: "(acrobatrelay.com|finconsult.cc|realmetaldns.com)"
      minCount: 1
      timeLapse: 60
      save:
        - field: "logx.*.proto"
          alias: "Protocol"
        - field: "logx.*.src_ip"
          alias: "SourceIP"
        - field: "logx.*.src_port"
          alias: "SourcePort"
        - field: "logx.*.dest_ip"
          alias: "DestinationIP"
        - field: "logx.*.dest_port"
          alias: "DestinationPort"
