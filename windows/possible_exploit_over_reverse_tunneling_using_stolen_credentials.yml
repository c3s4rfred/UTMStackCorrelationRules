# Rule version v1.0.1

- name: "Windows: User logged using Remote Desktop Connection from loopback address, possible exploit over reverse tunneling using stolen credentials"
  severity: "High"
  description: "Adversaries may use Valid Accounts to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions as the logged-on user."
  solution: "Audit the Remote Desktop Users group membership regularly. Remove unnecessary accounts and groups from Remote Desktop Users groups.	
      Use remote desktop gateways. Use multi-factor authentication for remote logins.	
      Consider removing the local Administrators group from the list of groups allowed to log in through RDP. 	
      Limit remote user permissions if remote access is necessary."
  category: "Potentially Compromised System"
  tactic: "Remote Services: Remote Desktop Protocol"
  dataTypes: ["wineventlog"]
  reference:
    - "https://attack.mitre.org/techniques/T1021/001/"
  frequency: 60
  cache:
    - allOf:
        - field: "logx.wineventlog.event_data.LogonType"
          operator: "=="
          value: "10"
        - field: "logx.wineventlog.host.ip.1"
          operator: "in"
          value: "::1,127.0.0.1"
        - field: "logx.wineventlog.event_id"
          operator: "in"
          value: 528,540,673,4624,4769
      timeLapse: 60
      minCount: 1
      save:
        - field: "logx.wineventlog.event_data.SubjectUserName"
          alias: "SourceUser"
        - field: "logx.wineventlog.host.name"
          alias: "SourceHost"
        - field: "logx.wineventlog.host.ip.1"
          alias: "SourceIP"
        - field: "logx.wineventlog.event_data.IpPort"
          alias: "SourcePort"
        - field: "logx.wineventlog.event_data.TargetUserName"
          alias: "DestinationUser"
