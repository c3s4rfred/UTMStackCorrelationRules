# Based on Privafy POC documentation
# Rule version v1.0.0

- name: "Privafy: Probable password guessing"
  severity: "High"
  description: "Adversaries with no prior knowledge of legitimate credentials within the system or environment 
               may guess passwords to attempt access to accounts. Without knowledge of the password for an account, 
               an adversary may opt to systematically guess the password using a repetitive or iterative mechanism. 
               An adversary may guess login credentials without prior knowledge of system or environment passwords 
               during an operation by using a list of common passwords. Password guessing may or may not take into 
               account the target's policies on password complexity or use policies that may lock accounts out after 
               a number of failed attempts."
  solution: "<ol>
    <li>Contact the Privafy provider for further information.</li>
    </ol>"
  category: "Credential Access"
  tactic: "Brute Force: Password Guessing"
  dataTypes: ["privafy"]
  reference: 
    - "https://attack.mitre.org/tactics/TA0006"
    - "https://attack.mitre.org/techniques/T1110/001/"
  frequency: 60
  cache:
    - allOf:
        - field: "logx.privafy.event_id"
          operator: "=="
          value: "4625"
        - field: "logx.privafy.embDeviceProduct"
          operator: "=="
          value: "EDR"
        - field: "logx.privafy.embName"
          operator: "start with"
          value: "Logon failure"
      minCount: 1
      timeLapse: 60
      save:
        - field: "logx.privafy.event_id"
          alias: "EVENT_ID"
        - field: "logx.privafy.embDeviceProduct"
          alias: "DEVICE_PRODUCT"
        - field: "logx.privafy.src_user"
          alias: "VERIFY_USER"
    - allOf:
        - field: "logx.privafy.event_id"
          operator: "=="
          value: "{{.EVENT_ID}}"
        - field: "logx.privafy.embDeviceProduct"
          operator: "=="
          value: "{{.DEVICE_PRODUCT}}"
        - field: "logx.privafy.embName"
          operator: "start with"
          value: "Logon failure"
        - field: "logx.privafy.src_user"
          operator: "=="
          alias: "{{.VERIFY_USER}}"
      minCount: 3
      timeLapse: 60
      save:
        - field: "logx.privafy.proto"
          alias: "Protocol"
        - field: "logx.privafy.src_user"
          alias: "SourceUser"
        - field: "logx.privafy.src_ip"
          alias: "SourceIP"
        - field: "logx.privafy.src_port"
          alias: "SourcePort"
        - field: "logx.privafy.dest_ip"
          alias: "DestinationIP"
        - field: "logx.privafy.dest_port"
          alias: "DestinationPort"
        - field: "logx.privafy.src_host"
          alias: "SourceHost"
